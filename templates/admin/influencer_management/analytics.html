{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ influencer.name }} - Analytics - JOOG Admin{% endblock %}

{% block extrahead %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.analytics-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.chart-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    margin-bottom: 20px;
}
.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
    margin-bottom: 15px;
}
.date-range-selector {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 15px;
}
.chart-container {
    position: relative;
    height: 400px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Analytics Header -->
    <div class="analytics-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-white bg-opacity-20 d-flex align-items-center justify-content-center me-3" 
                         style="width: 60px; height: 60px; font-size: 1.5rem; font-weight: bold;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h1 class="h2 mb-0">Analytics Dashboard</h1>
                        <p class="mb-0 opacity-75">{{ influencer.name }} (@{{ influencer.username }})</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="date-range-selector">
                    <label class="form-label small opacity-75 mb-2">Time Period</label>
                    <select class="form-select" id="dateRangeSelector" onchange="updateAnalytics()">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #3b82f6;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="h4 mb-1 text-primary">{{ total_orders }}</h3>
                        <p class="small text-muted mb-0">Total Orders</p>
                    </div>
                    <div class="rounded-circle bg-blue-100 p-3">
                        <i class="fas fa-shopping-cart text-primary"></i>
                    </div>
                </div>
                {% if orders_trend %}
                <div class="mt-2">
                    <small class="text-{% if orders_trend > 0 %}success{% else %}danger{% endif %}">
                        <i class="fas fa-arrow-{% if orders_trend > 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ orders_trend|floatformat:1 }}% vs previous period
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #10b981;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="h4 mb-1 text-success">₹{{ total_revenue|floatformat:0 }}</h3>
                        <p class="small text-muted mb-0">Revenue Generated</p>
                    </div>
                    <div class="rounded-circle bg-green-100 p-3">
                        <i class="fas fa-dollar-sign text-success"></i>
                    </div>
                </div>
                {% if revenue_trend %}
                <div class="mt-2">
                    <small class="text-{% if revenue_trend > 0 %}success{% else %}danger{% endif %}">
                        <i class="fas fa-arrow-{% if revenue_trend > 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ revenue_trend|floatformat:1 }}% vs previous period
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #8b5cf6;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="h4 mb-1 text-purple">₹{{ commission_earned|floatformat:0 }}</h3>
                        <p class="small text-muted mb-0">Commission Earned</p>
                    </div>
                    <div class="rounded-circle bg-purple-100 p-3">
                        <i class="fas fa-percentage text-purple"></i>
                    </div>
                </div>
                {% if commission_trend %}
                <div class="mt-2">
                    <small class="text-{% if commission_trend > 0 %}success{% else %}danger{% endif %}">
                        <i class="fas fa-arrow-{% if commission_trend > 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ commission_trend|floatformat:1 }}% vs previous period
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card" style="border-left-color: #f59e0b;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="h4 mb-1 text-warning">₹{{ avg_order_value|floatformat:0 }}</h3>
                        <p class="small text-muted mb-0">Avg. Order Value</p>
                    </div>
                    <div class="rounded-circle bg-yellow-100 p-3">
                        <i class="fas fa-receipt text-warning"></i>
                    </div>
                </div>
                {% if aov_trend %}
                <div class="mt-2">
                    <small class="text-{% if aov_trend > 0 %}success{% else %}danger{% endif %}">
                        <i class="fas fa-arrow-{% if aov_trend > 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ aov_trend|floatformat:1 }}% vs previous period
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Revenue Over Time Chart -->
        <div class="col-lg-8">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Revenue & Orders Over Time</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary active" onclick="toggleChartView('revenue')">Revenue</button>
                        <button class="btn btn-outline-primary" onclick="toggleChartView('orders')">Orders</button>
                        <button class="btn btn-outline-primary" onclick="toggleChartView('both')">Both</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Coupon Performance -->
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="mb-4"><i class="fas fa-tags me-2"></i>Coupon Performance</h5>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="couponChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Monthly Performance Table -->
        <div class="col-lg-8">
            <div class="chart-card">
                <h5 class="mb-4"><i class="fas fa-calendar me-2"></i>Monthly Performance</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Month</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Commission</th>
                                <th>Avg. Order</th>
                                <th>Growth</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month in monthly_data %}
                            <tr>
                                <td class="fw-bold">{{ month.month_name }}</td>
                                <td>{{ month.orders }}</td>
                                <td class="text-success">₹{{ month.revenue|floatformat:0 }}</td>
                                <td class="text-primary">₹{{ month.commission|floatformat:0 }}</td>
                                <td>₹{{ month.avg_order|floatformat:0 }}</td>
                                <td>
                                    {% if month.growth > 0 %}
                                        <span class="text-success">
                                            <i class="fas fa-arrow-up me-1"></i>{{ month.growth|floatformat:1 }}%
                                        </span>
                                    {% elif month.growth < 0 %}
                                        <span class="text-danger">
                                            <i class="fas fa-arrow-down me-1"></i>{{ month.growth|floatformat:1 }}%
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    No data available for the selected period
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Performing Coupons -->
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="mb-4"><i class="fas fa-trophy me-2"></i>Top Performing Coupons</h5>
                
                {% for coupon in top_coupons %}
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <div class="fw-bold font-monospace text-primary">{{ coupon.code }}</div>
                        <div class="small text-muted">{{ coupon.orders_count }} orders</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">₹{{ coupon.revenue|floatformat:0 }}</div>
                        <div class="small text-muted">₹{{ coupon.commission|floatformat:0 }} commission</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-tags fa-2x mb-3"></i>
                    <p>No coupon data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Customer Insights -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-4"><i class="fas fa-users me-2"></i>Customer Insights</h5>
                
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h4 text-primary">{{ unique_customers }}</div>
                        <div class="small text-muted">Unique Customers</div>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-success">{{ repeat_customers }}</div>
                        <div class="small text-muted">Repeat Customers</div>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-warning">{{ repeat_rate|floatformat:1 }}%</div>
                        <div class="small text-muted">Repeat Rate</div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6 class="mb-3">Recent Customer Activity</h6>
                    {% for customer in recent_customers %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <div class="small fw-bold">{{ customer.name|default:customer.username }}</div>
                            <div class="small text-muted">{{ customer.order_count }} orders</div>
                        </div>
                        <div class="text-end">
                            <div class="small fw-bold text-success">₹{{ customer.total_spent|floatformat:0 }}</div>
                            <div class="small text-muted">Last: {{ customer.last_order|date:"M d" }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-3 text-muted">
                        <p class="small">No customer data available</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="chart-card">
                <h5 class="mb-4"><i class="fas fa-clock me-2"></i>Performance Trends</h5>
                
                <!-- Day of Week Performance -->
                <div class="mb-4">
                    <h6 class="mb-3">Orders by Day of Week</h6>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="dayOfWeekChart"></canvas>
                    </div>
                </div>
                
                <!-- Conversion Metrics -->
                <div class="row text-center mt-4">
                    <div class="col-6">
                        <div class="h5 text-info">{{ conversion_rate|floatformat:1 }}%</div>
                        <div class="small text-muted">Conversion Rate</div>
                    </div>
                    <div class="col-6">
                        <div class="h5 text-purple">{{ clicks_to_orders }}</div>
                        <div class="small text-muted">Avg Clicks to Order</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Actions -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Analytics</h5>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="exportData('csv')">
                            <i class="fas fa-file-csv me-2"></i>Export CSV
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportData('pdf')">
                            <i class="fas fa-file-pdf me-2"></i>Export PDF
                        </button>
                        <a href="{% url 'influencers:admin_detail' influencer.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Chart data from Django context
const chartData = {
    revenue: {{ revenue_data|safe }},
    orders: {{ orders_data|safe }},
    coupons: {{ coupon_data|safe }},
    dayOfWeek: {{ day_of_week_data|safe }},
    labels: {{ chart_labels|safe }}
};

let revenueChart, couponChart, dayOfWeekChart;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Revenue ($)',
                data: chartData.revenue,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Coupon Performance Chart
    const couponCtx = document.getElementById('couponChart').getContext('2d');
    couponChart = new Chart(couponCtx, {
        type: 'doughnut',
        data: {
            labels: chartData.coupons.labels,
            datasets: [{
                data: chartData.coupons.data,
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', 
                    '#ef4444', '#06b6d4', '#84cc16', '#f97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Day of Week Chart
    const dayCtx = document.getElementById('dayOfWeekChart').getContext('2d');
    dayOfWeekChart = new Chart(dayCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Orders',
                data: chartData.dayOfWeek,
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function toggleChartView(view) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update chart data based on view
    if (view === 'revenue') {
        revenueChart.data.datasets = [{
            label: 'Revenue ($)',
            data: chartData.revenue,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        }];
    } else if (view === 'orders') {
        revenueChart.data.datasets = [{
            label: 'Orders',
            data: chartData.orders,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }];
    } else {
        revenueChart.data.datasets = [
            {
                label: 'Revenue ($)',
                data: chartData.revenue,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y'
            },
            {
                label: 'Orders',
                data: chartData.orders,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: false,
                yAxisID: 'y1'
            }
        ];
        
        // Add second y-axis for dual view
        revenueChart.options.scales.y1 = {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            grid: {
                drawOnChartArea: false,
            },
        };
    }
    
    revenueChart.update();
}

function updateAnalytics() {
    const days = document.getElementById('dateRangeSelector').value;
    window.location.href = `?days=${days}`;
}

function exportData(format) {
    const days = document.getElementById('dateRangeSelector').value;
    window.location.href = `{% url 'influencers:admin_export' %}?influencer={{ influencer.id }}&days=${days}&format=${format}`;
}
</script>
{% endblock %}