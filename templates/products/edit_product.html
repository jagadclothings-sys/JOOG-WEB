{% extends 'base.html' %}
{% load static %}

{% block title %}Edit {{ product.name }} - JOOG Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12">
    <div class="max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Edit Product</h1>
            <a href="{% url 'products:admin_products' %}" class="btn btn-outline">
                <i class="fas fa-arrow-left mr-2"></i> Back to Products
            </a>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-8">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <div>
                    <label class="form-label">{{ form.name.label_tag }}</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <div class="form-error">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label class="form-label">{{ form.slug.label_tag }}</label>
                    {{ form.slug }}
                    {% if form.slug.errors %}
                    <div class="form-error">{{ form.slug.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label class="form-label">{{ form.description.label_tag }}</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="form-error">{{ form.description.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label class="form-label">{{ form.price.label_tag }}</label>
                    {{ form.price }}
                    {% if form.price.errors %}
                    <div class="form-error">{{ form.price.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <!-- Size Stock Management -->
                <div>
                    <label class="form-label">Available Sizes & Stock</label>
                    <p class="text-sm text-gray-500 mb-3">Update stock quantity for each size. Set to 0 to remove a size from availability.</p>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center">
                            <label class="form-label text-sm">{{ form.size_s_stock.label_tag }}</label>
                            {{ form.size_s_stock }}
                            {% if form.size_s_stock.errors %}
                            <div class="form-error text-xs">{{ form.size_s_stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="text-center">
                            <label class="form-label text-sm">{{ form.size_m_stock.label_tag }}</label>
                            {{ form.size_m_stock }}
                            {% if form.size_m_stock.errors %}
                            <div class="form-error text-xs">{{ form.size_m_stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="text-center">
                            <label class="form-label text-sm">{{ form.size_l_stock.label_tag }}</label>
                            {{ form.size_l_stock }}
                            {% if form.size_l_stock.errors %}
                            <div class="form-error text-xs">{{ form.size_l_stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="text-center">
                            <label class="form-label text-sm">{{ form.size_xl_stock.label_tag }}</label>
                            {{ form.size_xl_stock }}
                            {% if form.size_xl_stock.errors %}
                            <div class="form-error text-xs">{{ form.size_xl_stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="text-center">
                            <label class="form-label text-sm">{{ form.size_xxl_stock.label_tag }}</label>
                            {{ form.size_xxl_stock }}
                            {% if form.size_xxl_stock.errors %}
                            <div class="form-error text-xs">{{ form.size_xxl_stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">{{ form.category.label_tag }}</label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <div class="form-error">{{ form.category.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label class="form-label">{{ form.image.label_tag }}</label>
                    {% if product.image %}
                    <div class="mb-2">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                             class="w-32 h-32 object-cover rounded-lg">
                        <p class="text-sm text-gray-500 mt-1">Current image</p>
                    </div>
                    {% endif %}
                    {{ form.image }}
                    {% if form.image.errors %}
                    <div class="form-error">{{ form.image.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="flex items-center">
                    {{ form.available }}
                    <label class="ml-2 text-sm text-gray-700">{{ form.available.label }}</label>
                    {% if form.available.errors %}
                    <div class="form-error">{{ form.available.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Current Additional Images -->
                {% if product.images.exists %}
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Current Additional Images</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {% for image in product.images.all %}
                        <div class="relative border rounded-lg overflow-hidden">
                            <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="w-full h-32 object-cover">
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white p-2">
                                <p class="text-xs truncate">{{ image.alt_text|default:'No alt text' }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Add More Images with Drag & Drop -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Add More Images</h3>
                    <p class="text-sm text-gray-500 mb-4">Upload additional product images using drag & drop or browse to select files.</p>
                    
                    <!-- Drag & Drop Upload Area -->
                    <div id="image-upload-area" class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-400 transition-colors cursor-pointer mb-4">
                        <input type="file" id="multiple-image-upload" name="images" multiple accept="image/*" class="hidden">
                        
                        <div id="upload-prompt" class="space-y-3">
                            <div class="mx-auto w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-xl text-gray-400"></i>
                            </div>
                            <div>
                                <h4 class="text-md font-medium text-gray-700">Drop new images here or click to browse</h4>
                                <p class="text-sm text-gray-500">PNG, JPG, JPEG, GIF, WEBP up to 5MB each (Max: 10 images)</p>
                            </div>
                            <button type="button" id="browse-images-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-images mr-2"></i>Select Images
                            </button>
                        </div>
                    </div>
                    
                    <!-- Image Preview Grid -->
                    <div id="image-preview-grid" class="hidden">
                        <h4 class="text-md font-semibold mb-3">New Images to Add</h4>
                        <div id="image-previews" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-3">
                            <!-- Image previews will be populated here -->
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>Click on images to edit or remove them</span>
                            <button type="button" id="clear-all-images" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash mr-1"></i>Clear All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Traditional Formset (for existing management) -->
                    <div class="mt-6">
                        <h4 class="text-md font-semibold mb-3">Manage Existing Images</h4>
                        <div id="extra-images" class="space-y-4">
                            {% if image_formset %}
                                {{ image_formset.management_form }}
                                {% for img_form in image_formset %}
                                <div class="p-4 border rounded-lg">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div>
                                            <label class="form-label">Image</label>
                                            {{ img_form.image }}
                                        </div>
                                        <div>
                                            <label class="form-label">Alt text</label>
                                            {{ img_form.alt_text }}
                                        </div>
                                        <div class="flex items-center space-x-4">
                                            {% if img_form.DELETE %}
                                            <label class="flex items-center space-x-2">
                                                {{ img_form.DELETE }}
                                                <span class="text-sm text-gray-600">Remove</span>
                                            </label>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="mt-3">
                            <button type="button" id="add-image-row" class="btn btn-outline btn-sm">+ Add another image field</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button type="submit" class="btn btn-primary">
                        Update Product <i class="fas fa-save ml-2"></i>
                    </button>
                    <a href="{% url 'products:admin_products' %}" class="btn btn-outline">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
  const addImageBtn = document.getElementById('add-image-row');
  if (!addImageBtn) return;
  const container = document.getElementById('extra-images');
  const totalFormsInput = document.querySelector('[name="' + ({{ image_formset.prefix|default:'productimage_set'|safe|escapejs }} || 'productimage_set') + '-TOTAL_FORMS"]');
  const emptyFormHtml = `{{ image_formset.empty_form.as_p|default:''|escapejs }}`;
  addImageBtn.addEventListener('click', function() {
    if (!totalFormsInput || !emptyFormHtml) return;
    let total = parseInt(totalFormsInput.value, 10);
    const html = emptyFormHtml.replace(/__prefix__/g, total);
    const wrapper = document.createElement('div');
    wrapper.className = 'p-4 border rounded-lg';
    wrapper.innerHTML = html;
    container.appendChild(wrapper);
    totalFormsInput.value = total + 1;
  });
        });
        
        // Drag & Drop Multiple Image Upload Functionality
        const uploadArea = document.getElementById('image-upload-area');
        const fileInput = document.getElementById('multiple-image-upload');
        const browseBtn = document.getElementById('browse-images-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const previewGrid = document.getElementById('image-preview-grid');
        const previewsContainer = document.getElementById('image-previews');
        const clearAllBtn = document.getElementById('clear-all-images');
        
        let selectedFiles = [];
        
        // File validation settings
        const MAX_FILES = 10;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        
        // Browse button click
        browseBtn.addEventListener('click', () => fileInput.click());
        
        // Upload area click
        uploadArea.addEventListener('click', (e) => {
            if (e.target === uploadArea || e.target === uploadPrompt || e.target.closest('#upload-prompt')) {
                fileInput.click();
            }
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        // Drag and drop events
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-red-400', 'bg-red-50');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-red-400', 'bg-red-50');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-red-400', 'bg-red-50');
            handleFiles(e.dataTransfer.files);
        });
        
        // Handle files function
        function handleFiles(files) {
            const fileArray = Array.from(files);
            
            // Check total file count
            if (selectedFiles.length + fileArray.length > MAX_FILES) {
                alert(`You can only upload a maximum of ${MAX_FILES} images.`);
                return;
            }
            
            // Validate and add files
            fileArray.forEach(file => {
                if (!ALLOWED_TYPES.includes(file.type)) {
                    alert(`File "${file.name}" is not a supported image format.`);
                    return;
                }
                
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                    return;
                }
                
                // Check if file already selected
                const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!isDuplicate) {
                    selectedFiles.push(file);
                }
            });
            
            updatePreviewGrid();
            updateFileInput();
        }
        
        // Update preview grid
        function updatePreviewGrid() {
            if (selectedFiles.length === 0) {
                previewGrid.classList.add('hidden');
                return;
            }
            
            previewGrid.classList.remove('hidden');
            previewsContainer.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative border rounded-lg overflow-hidden cursor-pointer hover:shadow-md transition-shadow';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="w-full h-32 object-cover">
                        <div class="absolute top-2 right-2">
                            <button type="button" class="remove-image-btn w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600" data-index="${index}">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white p-2">
                            <p class="text-xs truncate" title="${file.name}">${file.name}</p>
                            <p class="text-xs text-gray-300 truncate" title="${file.altText || 'No alt text'}">Alt: ${file.altText || 'Click to add alt text'}</p>
                        </div>
                    `;
                    
                    // Add click event for editing alt text
                    previewDiv.addEventListener('click', (e) => {
                        if (!e.target.closest('.remove-image-btn')) {
                            editImageAltText(index, file.name);
                        }
                    });
                    
                    previewsContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Remove image function
        previewsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-image-btn')) {
                const index = parseInt(e.target.closest('.remove-image-btn').dataset.index);
                selectedFiles.splice(index, 1);
                updatePreviewGrid();
                updateFileInput();
            }
        });
        
        // Clear all images
        clearAllBtn.addEventListener('click', () => {
            selectedFiles = [];
            updatePreviewGrid();
            updateFileInput();
        });
        
        // Update file input with selected files
        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => {
                if (!file.altText) file.altText = '';
                dataTransfer.items.add(file);
            });
            fileInput.files = dataTransfer.files;
        }
        
        // Edit alt text function
        function editImageAltText(index, fileName) {
            const currentAltText = selectedFiles[index].altText || '';
            
            // Create modal for alt text editing
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Edit Alt Text</h3>
                    <p class="text-sm text-gray-600 mb-3">Image: ${fileName}</p>
                    <textarea id="alt-text-input" class="w-full p-2 border rounded-lg resize-none" rows="3" placeholder="Enter descriptive text for this image...">${currentAltText}</textarea>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" id="cancel-alt-edit" class="btn btn-outline btn-sm">Cancel</button>
                        <button type="button" id="save-alt-text" class="btn btn-primary btn-sm">Save</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const altTextInput = modal.querySelector('#alt-text-input');
            const cancelBtn = modal.querySelector('#cancel-alt-edit');
            const saveBtn = modal.querySelector('#save-alt-text');
            
            altTextInput.focus();
            altTextInput.select();
            
            // Save alt text
            const saveAltText = () => {
                selectedFiles[index].altText = altTextInput.value.trim();
                document.body.removeChild(modal);
                updatePreviewGrid(); // Refresh the display
            };
            
            // Cancel edit
            const cancelEdit = () => {
                document.body.removeChild(modal);
            };
            
            saveBtn.addEventListener('click', saveAltText);
            cancelBtn.addEventListener('click', cancelEdit);
            
            // Close on escape key
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cancelEdit();
                }
            });
        }
        
        // Add form submission handler to include alt text data
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Create hidden inputs for alt texts
                const existingAltInputs = document.querySelectorAll('input[name="image_alt_texts"]');
                existingAltInputs.forEach(input => input.remove());
                
                selectedFiles.forEach((file, index) => {
                    const altTextInput = document.createElement('input');
                    altTextInput.type = 'hidden';
                    altTextInput.name = 'image_alt_texts';
                    altTextInput.value = file.altText || '';
                    form.appendChild(altTextInput);
                });
            });
        }
    </script>
{% endblock content %}
