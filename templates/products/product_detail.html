{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - JOOG{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
        <!-- Product Images -->
        <div class="space-y-4">
            <!-- Main Image Display -->
            <div class="relative aspect-square rounded-lg overflow-hidden bg-gray-100 group cursor-pointer" id="main-image-container">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                     class="main-image w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                     data-large="{{ product.image.url }}"
                     onclick="openImageViewer('{{ product.image.url }}', '{{ product.name }}', 0)">
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <i class="fas fa-image text-gray-400 text-6xl"></i>
                </div>
                {% endif %}
                
                <!-- Zoom Icon Overlay -->
                <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <i class="fas fa-search-plus text-lg"></i>
                </div>
                
                <!-- View All Images Button -->
                {% if product.images.exists %}
                <div class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white rounded-lg px-3 py-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300 text-sm">
                    <i class="fas fa-images mr-2"></i>{{ product.images.count|add:1 }} Images
                </div>
                {% endif %}
            </div>
            
            <!-- Thumbnail Gallery -->
            {% if product.images.exists %}
            <div class="grid grid-cols-4 gap-2" id="thumbnail-gallery">
                <!-- Main product image thumbnail -->
                {% if product.image %}
                <div class="aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer hover:ring-2 hover:ring-red-500 thumbnail active" 
                     data-image="{{ product.image.url }}" data-index="0" onclick="switchMainImage('{{ product.image.url }}', 0)">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                         class="w-full h-full object-cover">
                </div>
                {% endif %}
                
                <!-- Additional product images -->
                {% for image in product.images.all %}
                <div class="aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer hover:ring-2 hover:ring-red-500 thumbnail" 
                     data-image="{{ image.image.url }}" data-index="{{ forloop.counter }}" onclick="switchMainImage('{{ image.image.url }}', {{ forloop.counter }})">
                    {% if image.image %}
                    <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" 
                         class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center">
                        <i class="fas fa-image text-gray-400 text-lg"></i>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div class="space-y-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ product.name }}</h1>
                <p class="text-gray-600">{{ product.category.name }}</p>
            </div>
            
            <div class="text-3xl font-bold text-red-600 price">₹{{ product.price }}</div>
            
            <div>
                <h3 class="font-semibold mb-2">Description</h3>
                <p class="text-gray-600 leading-relaxed">{{ product.description }}</p>
            </div>
            
            <div>
                <h3 class="font-semibold mb-2">Availability</h3>
                {% if product.stock > 0 %}
                <p class="text-green-600 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    In Stock
                </p>
                {% else %}
                <p class="text-red-600 flex items-center">
                    <i class="fas fa-times-circle mr-2"></i>
                    Out of Stock
                </p>
                {% endif %}
            </div>
            
            {% if product.stock > 0 %}
            <div class="space-y-4">
                <form method="POST" action="{% url 'orders:add_to_cart' product.id %}" class="space-y-4" id="add-to-cart-form">
                    {% csrf_token %}
                    
                    <!-- Size Selection -->
                    <div class="mb-6">
                        <label class="block mb-3 font-semibold text-lg">Select Size</label>
                        {% if available_sizes %}
                        <div class="flex flex-wrap gap-3 mb-4" id="size-buttons">
                            {% for size_info in available_sizes %}
                            <button type="button" 
                                    class="size-btn px-4 py-3 border-2 border-gray-300 rounded-lg font-semibold text-sm hover:border-red-500 hover:bg-red-50 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" 
                                    data-size="{{ size_info.size }}" 
                                    data-stock="{{ size_info.quantity }}">
                                {{ size_info.size }}
                            </button>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="size" id="selected-size" required>
                        <p class="text-sm text-gray-600 mb-2">Selected size: <span id="size-display" class="font-semibold text-red-600">None</span></p>
                        {% else %}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-yellow-800 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                No sizes currently available for this product.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    <!-- Quantity Selection -->
                    {% if available_sizes %}
                    <div class="flex items-center space-x-4 mb-6">
                        <label class="font-semibold">Quantity:</label>
                        <select name="quantity" id="quantity-select" class="form-input w-20" disabled>
                            {% for i in "12345" %}
                            <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                            {% endfor %}
                        </select>
                        <span class="text-sm text-gray-500" id="quantity-limit"></span>
                    </div>
                    
                    <div class="flex flex-col space-y-3">
                        <div class="flex space-x-4">
                            <button type="submit" id="add-to-cart-btn" class="btn btn-primary flex-1" disabled>
                                Add to Cart <i class="fas fa-shopping-cart ml-2"></i>
                            </button>
                            <button type="button" class="btn btn-outline wishlist-btn" data-product-id="{{ product.id }}" id="wishlist-btn-{{ product.id }}">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        <button type="submit" id="buy-now-btn" class="btn btn-success w-full" formaction="{% url 'orders:buy_now' product.id %}" formmethod="post" disabled>
                            Buy Now <i class="fas fa-bolt ml-2"></i>
                        </button>
                    </div>
                    {% endif %}
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Product Reviews -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-12">
        <h2 class="text-xl font-bold mb-4">Customer Reviews</h2>
        
        {% if user.is_authenticated and review_form %}
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-semibold mb-3 text-lg">Write a Review</h3>
            <form method="POST" class="space-y-4">
                {% csrf_token %}
                <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-6 space-y-4 sm:space-y-0">
                    <div class="flex-shrink-0">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                        <div class="star-rating" data-rating="0">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="rating" id="rating-input" value="">
                    </div>
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Comment</label>
                        <textarea name="comment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none" placeholder="Share your experience with this product..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="btn btn-primary px-6 py-2">Submit Review</button>
                </div>
            </form>
        </div>
        {% endif %}
        
        {% if reviews %}
        <div class="space-y-4">
            {% for review in reviews %}
            <div class="border-b border-gray-200 pb-4 last:border-b-0">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <h4 class="font-semibold text-gray-800">{{ review.user.get_full_name|default:review.user.username }}</h4>
                        <div class="flex text-yellow-500 text-sm">
                            {% for i in "12345" %}
                            {% if forloop.counter <= review.rating %}
                            <i class="fas fa-star"></i>
                            {% else %}
                            <i class="far fa-star text-gray-300"></i>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <span class="text-gray-500 text-sm">{{ review.created_at|date:"M d, Y" }}</span>
                </div>
                <p class="text-gray-600 text-sm leading-relaxed">{{ review.comment }}</p>
                {% if user.is_staff %}
                <div class="mt-2">
                    <button onclick="deleteReview({{ review.id }})" class="text-red-600 hover:text-red-800 text-xs">
                        <i class="fas fa-trash mr-1"></i>Delete Review
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-center py-6 text-sm">No reviews yet. Be the first to review this product!</p>
        {% endif %}
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="mb-16">
        <h2 class="text-2xl font-bold mb-8 text-gray-800">You Might Also Like</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for product in related_products %}
            <div class="product-card">
                <div class="relative overflow-hidden group">
                    <a href="{% url 'products:product_detail' product.slug %}">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                             class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300">
                        {% else %}
                        <div class="w-full h-48 bg-gray-200 flex items-center justify-center group-hover:scale-105 transition-transform duration-300">
                            <i class="fas fa-image text-gray-400 text-3xl"></i>
                        </div>
                        {% endif %}
                    </a>
                </div>
                <div class="p-4">
                    <h3 class="font-semibold text-lg mb-2">{{ product.name }}</h3>
                    <p class="text-red-600 font-bold">₹{{ product.price }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Image Viewer Modal -->
<div id="imageViewerModal" class="image-viewer-modal">
    <div class="image-viewer-overlay" onclick="closeImageViewer()"></div>
    <div class="image-viewer-container">
        <!-- Close Button -->
        <button class="image-viewer-close" onclick="closeImageViewer()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Image Display -->
        <div class="image-viewer-content">
            <div class="image-viewer-main">
                <img id="viewerMainImage" src="" alt="" class="viewer-image">
                
                <!-- Zoom Controls -->
                <div class="image-viewer-controls">
                    <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="control-btn" onclick="resetZoom()" title="Reset Zoom">
                        <i class="fas fa-compress-alt"></i>
                    </button>
                    <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="control-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Navigation Arrows -->
            <button class="image-viewer-nav nav-prev" onclick="previousImage()" title="Previous Image">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="image-viewer-nav nav-next" onclick="nextImage()" title="Next Image">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Image Info -->
        <div class="image-viewer-info">
            <h3 id="viewerImageTitle">{{ product.name }}</h3>
            <div class="image-counter">
                <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
            </div>
        </div>
        
        <!-- Thumbnail Strip -->
        <div class="image-viewer-thumbnails" id="viewerThumbnails">
            <!-- Thumbnails will be populated by JavaScript -->
        </div>
    </div>
</div>

<style>
.size-btn.selected {
    background-color: #dc2626 !important;
    border-color: #dc2626 !important;
    color: white !important;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#quantity-select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.size-btn:hover:not(.selected) {
    border-color: #dc2626;
    background-color: #fef2f2;
}

/* Thumbnail Gallery Styles */
.thumbnail {
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.thumbnail.active {
    border-color: #dc2626 !important;
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
}

.thumbnail:hover {
    transform: scale(1.05);
}

/* Image Viewer Modal Styles */
.image-viewer-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-viewer-modal.active {
    display: flex;
    opacity: 1;
    align-items: center;
    justify-content: center;
}

.image-viewer-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.image-viewer-container {
    position: relative;
    width: 95%;
    height: 95%;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
}

.image-viewer-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    cursor: pointer;
    z-index: 11;
    transition: all 0.2s ease;
}

.image-viewer-close:hover {
    background: rgba(220, 38, 38, 0.8);
    transform: scale(1.1);
}

.image-viewer-content {
    position: relative;
    flex: 1;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.image-viewer-main {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.viewer-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    cursor: grab;
    transition: transform 0.3s ease;
    user-select: none;
    -webkit-user-drag: none;
}

.viewer-image.dragging {
    cursor: grabbing;
}

.viewer-image.zoomed {
    cursor: move;
}

/* Image Viewer Controls */
.image-viewer-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(0, 0, 0, 0.7);
    padding: 10px;
    border-radius: 25px;
    backdrop-filter: blur(10px);
}

.control-btn {
    background: transparent;
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
}

.control-btn:hover {
    background: rgba(220, 38, 38, 0.8);
    border-color: #dc2626;
    transform: scale(1.1);
}

/* Navigation Arrows */
.image-viewer-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 12;
}

.image-viewer-nav:hover {
    background: rgba(220, 38, 38, 0.8);
    transform: translateY(-50%) scale(1.1);
}

.nav-prev {
    left: 30px;
}

.nav-next {
    right: 30px;
}

/* Image Info */
.image-viewer-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 20px;
    color: white;
}

.image-viewer-info h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.image-counter {
    background: rgba(0, 0, 0, 0.7);
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 14px;
}

/* Thumbnail Strip */
.image-viewer-thumbnails {
    display: flex;
    gap: 10px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    max-width: 100%;
    overflow-x: auto;
}

.viewer-thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    flex-shrink: 0;
}

.viewer-thumbnail:hover {
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.viewer-thumbnail.active {
    border-color: #dc2626;
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3);
}

.viewer-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .image-viewer-container {
        width: 100%;
        height: 100%;
    }
    
    .image-viewer-close {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .image-viewer-nav {
        width: 50px;
        height: 50px;
        font-size: 16px;
    }
    
    .nav-prev {
        left: 10px;
    }
    
    .nav-next {
        right: 10px;
    }
    
    .image-viewer-controls {
        bottom: 10px;
        padding: 8px;
    }
    
    .control-btn {
        width: 35px;
        height: 35px;
        font-size: 12px;
    }
    
    .image-viewer-thumbnails {
        padding: 10px;
    }
    
    .viewer-thumbnail {
        width: 50px;
        height: 50px;
    }
}

/* Hide scrollbars in thumbnail strip */
.image-viewer-thumbnails::-webkit-scrollbar {
    height: 4px;
}

.image-viewer-thumbnails::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.image-viewer-thumbnails::-webkit-scrollbar-thumb {
    background: rgba(220, 38, 38, 0.6);
    border-radius: 2px;
}

.image-viewer-thumbnails::-webkit-scrollbar-thumb:hover {
    background: rgba(220, 38, 38, 0.8);
}
</style>

<script>
// Image Viewer Global Variables
let currentImageIndex = 0;
let imageList = [];
let zoomLevel = 1;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let imageStartX = 0;
let imageStartY = 0;
let isFullscreen = false;

// Initialize image list
function initializeImageList() {
    imageList = [];
    
    // Add main product image if exists
    {% if product.image %}
    imageList.push({
        url: '{{ product.image.url }}',
        alt: '{{ product.name }}'
    });
    {% endif %}
    
    // Add additional product images
    {% for image in product.images.all %}
    {% if image.image %}
    imageList.push({
        url: '{{ image.image.url }}',
        alt: '{{ image.alt_text|default:product.name }}'
    });
    {% endif %}
    {% endfor %}
}

// Switch main image in product display
function switchMainImage(imageUrl, index) {
    const mainImage = document.querySelector('.main-image');
    if (mainImage) {
        mainImage.src = imageUrl;
        mainImage.setAttribute('data-large', imageUrl);
        mainImage.setAttribute('onclick', `openImageViewer('${imageUrl}', '{{ product.name }}', ${index})`);
    }
    
    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    document.querySelector(`[data-index="${index}"]`).classList.add('active');
}

// Open image viewer modal
function openImageViewer(imageUrl, title, index) {
    currentImageIndex = index;
    const modal = document.getElementById('imageViewerModal');
    const viewerImage = document.getElementById('viewerMainImage');
    const imageTitle = document.getElementById('viewerImageTitle');
    const currentIndexSpan = document.getElementById('currentImageIndex');
    const totalImagesSpan = document.getElementById('totalImages');
    
    // Initialize image list if not done
    if (imageList.length === 0) {
        initializeImageList();
    }
    
    // Set image and title
    viewerImage.src = imageUrl;
    viewerImage.alt = title;
    imageTitle.textContent = title;
    
    // Update image counter
    currentIndexSpan.textContent = index + 1;
    totalImagesSpan.textContent = imageList.length;
    
    // Reset zoom
    resetZoom();
    
    // Show modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Generate thumbnails
    generateViewerThumbnails();
    
    // Show/hide navigation arrows based on image count
    updateNavigationVisibility();
    
    // Add keyboard event listeners
    document.addEventListener('keydown', handleKeydown);
}

// Close image viewer modal
function closeImageViewer() {
    const modal = document.getElementById('imageViewerModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    
    // Reset zoom and position
    resetZoom();
    
    // Remove keyboard event listeners
    document.removeEventListener('keydown', handleKeydown);
}

// Handle keyboard navigation
function handleKeydown(event) {
    switch(event.key) {
        case 'Escape':
            closeImageViewer();
            break;
        case 'ArrowLeft':
            previousImage();
            break;
        case 'ArrowRight':
            nextImage();
            break;
        case '+':
        case '=':
            zoomIn();
            break;
        case '-':
            zoomOut();
            break;
        case '0':
            resetZoom();
            break;
        case 'f':
        case 'F':
            toggleFullscreen();
            break;
    }
}

// Navigate to previous image
function previousImage() {
    if (imageList.length <= 1) return;
    
    currentImageIndex = (currentImageIndex - 1 + imageList.length) % imageList.length;
    updateViewerImage();
}

// Navigate to next image
function nextImage() {
    if (imageList.length <= 1) return;
    
    currentImageIndex = (currentImageIndex + 1) % imageList.length;
    updateViewerImage();
}

// Update viewer image
function updateViewerImage() {
    const viewerImage = document.getElementById('viewerMainImage');
    const imageTitle = document.getElementById('viewerImageTitle');
    const currentIndexSpan = document.getElementById('currentImageIndex');
    
    if (imageList[currentImageIndex]) {
        viewerImage.src = imageList[currentImageIndex].url;
        viewerImage.alt = imageList[currentImageIndex].alt;
        imageTitle.textContent = imageList[currentImageIndex].alt;
        currentIndexSpan.textContent = currentImageIndex + 1;
        
        // Reset zoom when changing images
        resetZoom();
        
        // Update active thumbnail
        updateActiveThumbnail();
    }
}

// Zoom functions
function zoomIn() {
    zoomLevel = Math.min(zoomLevel * 1.3, 5); // Max 5x zoom
    applyZoom();
}

function zoomOut() {
    zoomLevel = Math.max(zoomLevel / 1.3, 0.5); // Min 0.5x zoom
    applyZoom();
}

function resetZoom() {
    zoomLevel = 1;
    applyZoom();
    
    const viewerImage = document.getElementById('viewerMainImage');
    viewerImage.style.left = '0px';
    viewerImage.style.top = '0px';
}

function applyZoom() {
    const viewerImage = document.getElementById('viewerMainImage');
    viewerImage.style.transform = `scale(${zoomLevel})`;
    
    if (zoomLevel > 1) {
        viewerImage.classList.add('zoomed');
        enableImageDragging();
    } else {
        viewerImage.classList.remove('zoomed');
        disableImageDragging();
    }
}

// Image dragging functionality
function enableImageDragging() {
    const viewerImage = document.getElementById('viewerMainImage');
    
    viewerImage.addEventListener('mousedown', startDrag);
    viewerImage.addEventListener('touchstart', startDrag);
}

function disableImageDragging() {
    const viewerImage = document.getElementById('viewerMainImage');
    
    viewerImage.removeEventListener('mousedown', startDrag);
    viewerImage.removeEventListener('touchstart', startDrag);
}

function startDrag(event) {
    event.preventDefault();
    isDragging = true;
    
    const clientX = event.type === 'touchstart' ? event.touches[0].clientX : event.clientX;
    const clientY = event.type === 'touchstart' ? event.touches[0].clientY : event.clientY;
    
    dragStartX = clientX;
    dragStartY = clientY;
    
    const viewerImage = document.getElementById('viewerMainImage');
    const rect = viewerImage.getBoundingClientRect();
    imageStartX = rect.left;
    imageStartY = rect.top;
    
    viewerImage.classList.add('dragging');
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchmove', drag);
    document.addEventListener('touchend', endDrag);
}

function drag(event) {
    if (!isDragging) return;
    
    event.preventDefault();
    
    const clientX = event.type === 'touchmove' ? event.touches[0].clientX : event.clientX;
    const clientY = event.type === 'touchmove' ? event.touches[0].clientY : event.clientY;
    
    const deltaX = clientX - dragStartX;
    const deltaY = clientY - dragStartY;
    
    const viewerImage = document.getElementById('viewerMainImage');
    viewerImage.style.left = deltaX + 'px';
    viewerImage.style.top = deltaY + 'px';
}

function endDrag() {
    isDragging = false;
    
    const viewerImage = document.getElementById('viewerMainImage');
    viewerImage.classList.remove('dragging');
    
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', endDrag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('touchend', endDrag);
}

// Mouse wheel zoom
function setupMouseWheelZoom() {
    const viewerImage = document.getElementById('viewerMainImage');
    
    viewerImage.addEventListener('wheel', function(event) {
        event.preventDefault();
        
        if (event.deltaY < 0) {
            zoomIn();
        } else {
            zoomOut();
        }
    });
}

// Toggle fullscreen
function toggleFullscreen() {
    const modal = document.getElementById('imageViewerModal');
    
    if (!isFullscreen) {
        if (modal.requestFullscreen) {
            modal.requestFullscreen();
        } else if (modal.mozRequestFullScreen) {
            modal.mozRequestFullScreen();
        } else if (modal.webkitRequestFullscreen) {
            modal.webkitRequestFullscreen();
        } else if (modal.msRequestFullscreen) {
            modal.msRequestFullscreen();
        }
        isFullscreen = true;
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        isFullscreen = false;
    }
}

// Generate viewer thumbnails
function generateViewerThumbnails() {
    const thumbnailContainer = document.getElementById('viewerThumbnails');
    thumbnailContainer.innerHTML = '';
    
    imageList.forEach((image, index) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = `viewer-thumbnail ${index === currentImageIndex ? 'active' : ''}`;
        thumbnail.onclick = () => {
            currentImageIndex = index;
            updateViewerImage();
        };
        
        const img = document.createElement('img');
        img.src = image.url;
        img.alt = image.alt;
        
        thumbnail.appendChild(img);
        thumbnailContainer.appendChild(thumbnail);
    });
}

// Update active thumbnail in viewer
function updateActiveThumbnail() {
    document.querySelectorAll('.viewer-thumbnail').forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentImageIndex);
    });
}

// Update navigation arrow visibility
function updateNavigationVisibility() {
    const prevBtn = document.querySelector('.nav-prev');
    const nextBtn = document.querySelector('.nav-next');
    const thumbnailContainer = document.getElementById('viewerThumbnails');
    
    if (imageList.length <= 1) {
        // Hide navigation for single image
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (thumbnailContainer) thumbnailContainer.style.display = 'none';
    } else {
        // Show navigation for multiple images
        if (prevBtn) prevBtn.style.display = 'block';
        if (nextBtn) nextBtn.style.display = 'block';
        if (thumbnailContainer) thumbnailContainer.style.display = 'flex';
    }
}

// Double-click to zoom
function setupDoubleClickZoom() {
    const viewerImage = document.getElementById('viewerMainImage');
    
    viewerImage.addEventListener('dblclick', function(event) {
        event.preventDefault();
        
        if (zoomLevel === 1) {
            zoomLevel = 2;
        } else {
            zoomLevel = 1;
        }
        
        applyZoom();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize image functionality
    initializeImageList();
    setupMouseWheelZoom();
    setupDoubleClickZoom();
    
    // Original size selection code
    const sizeButtons = document.querySelectorAll('.size-btn');
    const selectedSizeInput = document.getElementById('selected-size');
    const sizeDisplay = document.getElementById('size-display');
    const quantitySelect = document.getElementById('quantity-select');
    const quantityLimit = document.getElementById('quantity-limit');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const buyNowBtn = document.getElementById('buy-now-btn');
    
    let currentSelectedSize = null;
    
    sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const size = this.dataset.size;
            const stock = parseInt(this.dataset.stock);
            
            // Update visual selection
            sizeButtons.forEach(btn => {
                btn.classList.remove('selected', 'border-red-500', 'bg-red-500', 'text-white');
                btn.classList.add('border-gray-300');
            });
            
            // Select current button
            this.classList.remove('border-gray-300');
            this.classList.add('selected', 'border-red-500', 'bg-red-500', 'text-white');
            
            // Update form values
            selectedSizeInput.value = size;
            sizeDisplay.textContent = size;
            currentSelectedSize = size;
            
            // Enable quantity select and update options
            quantitySelect.disabled = false;
            quantitySelect.innerHTML = '';
            
            const maxQuantity = Math.min(stock, 5); // Limit to stock or 5, whichever is lower
            for(let i = 1; i <= maxQuantity; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                quantitySelect.appendChild(option);
            }
            
            // Update quantity limit text
            if(stock <= 5) {
                quantityLimit.textContent = `(${stock} available)`;
            } else {
                quantityLimit.textContent = '(Max 5 per order)';
            }
            
            // Enable add to cart and buy now buttons
            addToCartBtn.disabled = false;
            addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            if (buyNowBtn) {
                buyNowBtn.disabled = false;
                buyNowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    });
    
    // Form validation
    document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
        if (!currentSelectedSize) {
            e.preventDefault();
            alert('Please select a size before adding to cart.');
            return false;
        }
    });
});
</script>
{% endblock %}

{% block extra_head %}
<style>
/* Star Rating Styles */
.star-rating {
    display: flex;
    gap: 2px;
    font-size: 1.25rem;
}

.star-rating i {
    color: #d1d5db;
    cursor: pointer;
    transition: color 0.2s ease;
}

.star-rating i:hover,
.star-rating i.active {
    color: #fbbf24;
}

.star-rating i.hover {
    color: #fbbf24;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wishlist functionality
    const wishlistBtn = document.querySelector('.wishlist-btn');
    
    if (wishlistBtn) {
        wishlistBtn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch('/accounts/wishlist/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    this.classList.remove('btn-outline');
                    this.classList.add('btn-primary');
                    this.querySelector('i').classList.add('text-red-600');
                    
                    // Show message
                    showMessage(data.message, 'success');
                } else if (data.status === 'removed') {
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline');
                    this.querySelector('i').classList.remove('text-red-600');
                    
                    // Show message
                    showMessage(data.message, 'success');
                } else if (data.error) {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
            });
        });
    }
    
    // Star rating functionality
    const starRating = document.querySelector('.star-rating');
    const ratingInput = document.getElementById('rating-input');
    
    if (starRating && ratingInput) {
        const stars = starRating.querySelectorAll('i');
        
        stars.forEach((star, index) => {
            // Hover effect
            star.addEventListener('mouseenter', function() {
                stars.forEach((s, i) => {
                    if (i <= index) {
                        s.classList.add('hover');
                    } else {
                        s.classList.remove('hover');
                    }
                });
            });
            
            // Click to select rating
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.value);
                ratingInput.value = rating;
                
                stars.forEach((s, i) => {
                    s.classList.remove('active', 'hover');
                    if (i < rating) {
                        s.classList.add('active');
                    }
                });
            });
        });
        
        // Remove hover effect when leaving star rating area
        starRating.addEventListener('mouseleave', function() {
            stars.forEach(star => {
                star.classList.remove('hover');
            });
        });
    }
});

// Delete review function for admin
function deleteReview(reviewId) {
    if (confirm('Are you sure you want to delete this review?')) {
        fetch(`/products/reviews/delete/${reviewId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Review deleted successfully', 'success');
                location.reload();
            } else {
                showMessage(data.error || 'Failed to delete review', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while deleting the review', 'error');
        });
    }
}

function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'} fixed top-4 right-4 z-50 max-w-sm`;
    messageDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add to document
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}
</script>
{% endblock %}
